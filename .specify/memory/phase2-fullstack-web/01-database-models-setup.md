# Constitution: Database Foundation & SQLModel Setup

## Project Context
Phase II of Hackathon Todo App - Transitioning from in-memory console application to cloud-based full-stack web application with persistent multi-user data storage.

---

## Mission Statement
Establish a robust, scalable database foundation using **Neon Serverless PostgreSQL** and **SQLModel ORM** to support multi-user todo task management with proper data isolation, relationships, and security.

---

## Core Objectives

### Primary Goals
1. Set up Neon Serverless PostgreSQL cloud database (free tier)
2. Design and implement SQLModel data models for Users and Tasks
3. Establish secure database connection with environment-based configuration
4. Create database tables programmatically with proper relationships
5. Implement basic CRUD operations for validation
6. Test database connectivity and data persistence

### Success Criteria
- ‚úÖ Neon database is created and accessible remotely
- ‚úÖ SQLModel models are defined with proper types and constraints
- ‚úÖ Database connection works via environment variables
- ‚úÖ Tables are created automatically on first run
- ‚úÖ Can create, read, update, and delete records
- ‚úÖ User-Task relationship is properly established (One-to-Many)
- ‚úÖ Data persists between application restarts
- ‚úÖ No hardcoded credentials in code

---

## Technical Requirements

### Database Service
- **Provider:** Neon Serverless PostgreSQL
- **Tier:** Free tier (sufficient for hackathon)
- **Region:** Choose closest to Pakistan (US East or EU recommended)
- **Connection:** SSL-enabled, serverless architecture

### ORM & Database Layer
- **ORM:** SQLModel (FastAPI's native ORM, built on SQLAlchemy + Pydantic)
- **Database Driver:** psycopg2-binary (PostgreSQL adapter for Python)
- **Migration Strategy:** Automatic table creation via SQLModel.metadata.create_all()
- **Connection Pooling:** Built-in with SQLModel engine

### Python Dependencies
```toml
[project]
dependencies = [
    "sqlmodel>=0.0.14",
    "psycopg2-binary>=2.9.9",
    "python-dotenv>=1.0.0"
]
```

---

## Data Model Specifications

### User Model Requirements
**Purpose:** Store user account information for authentication and task ownership

**Fields:**
- `id`: Integer, Primary Key, Auto-increment
- `email`: String, Unique, Indexed, Not Null, Max 255 chars
- `name`: String, Not Null, Max 100 chars
- `hashed_password`: String, Not Null (bcrypt/argon2 hashed)
- `created_at`: DateTime, Auto-set to current UTC time
- `updated_at`: DateTime, Auto-update on modifications

**Relationships:**
- One User ‚Üí Many Tasks (back_populates="user")

**Constraints:**
- Email must be unique (database level)
- Email must be validated format (application level)
- Password must be hashed, never stored plain text

---

### Task Model Requirements
**Purpose:** Store todo task items with user ownership

**Fields:**
- `id`: Integer, Primary Key, Auto-increment
- `user_id`: Integer, Foreign Key ‚Üí users.id, Not Null, Indexed
- `title`: String, Not Null, Max 200 chars
- `description`: Text, Optional (empty string default), Max 1000 chars
- `completed`: Boolean, Default False
- `created_at`: DateTime, Auto-set to current UTC time
- `updated_at`: DateTime, Auto-update on modifications

**Relationships:**
- Many Tasks ‚Üí One User (back_populates="tasks")

**Constraints:**
- Tasks must belong to a user (user_id required)
- Title cannot be empty
- Completed defaults to False
- Foreign key constraint ensures referential integrity

---

## Database Schema Design
```sql
-- Auto-generated by SQLModel (for reference)

CREATE TABLE "user" (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_email ON "user"(email);

CREATE TABLE task (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT DEFAULT '',
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_task_user_id ON task(user_id);
CREATE INDEX idx_task_completed ON task(completed);
```

---

## Security & Best Practices

### Environment Variables
Store sensitive configuration in `.env` file (never commit to Git):
```env
DATABASE_URL=postgresql://username:password@host.neon.tech/dbname?sslmode=require
```

### Password Security
- Never store plain text passwords
- Use bcrypt or argon2 for hashing
- Minimum password length: 8 characters

### Database Connection Security
- Use SSL/TLS for connections (Neon enforces this)
- Connection string includes `?sslmode=require`
- No hardcoded credentials in source code

### Data Isolation
- Each user can only access their own tasks
- Enforced at application layer (API will validate)
- Database relationships support this with foreign keys

---

## File Structure & Organization
```
hackathon2-todo-app/
‚îú‚îÄ‚îÄ backend/                          # New folder for Phase II backend
‚îÇ   ‚îú‚îÄ‚îÄ .env                          # Environment variables (excluded from Git)
‚îÇ   ‚îú‚îÄ‚îÄ .env.example                  # Template for environment variables
‚îÇ   ‚îú‚îÄ‚îÄ pyproject.toml                # Python dependencies
‚îÇ   ‚îú‚îÄ‚îÄ uv.lock                       # Dependency lock file
‚îÇ   ‚îú‚îÄ‚îÄ main.py                       # FastAPI application entry (future)
‚îÇ   ‚îú‚îÄ‚îÄ models.py                     # ‚≠ê SQLModel data models (THIS ITERATION)
‚îÇ   ‚îú‚îÄ‚îÄ db.py                         # ‚≠ê Database connection & session (THIS ITERATION)
‚îÇ   ‚îú‚îÄ‚îÄ test_db.py                    # ‚≠ê Database connectivity test script
‚îÇ   ‚îî‚îÄ‚îÄ README.md                     # Backend setup instructions
‚îÇ
‚îî‚îÄ‚îÄ C:\hackathon2-todo-app\specs\phase2-fullstack-web\01-database-models-setup/
    ‚îú‚îÄ‚îÄ specs.md                      # Detailed technical specifications
    ‚îú‚îÄ‚îÄ clarify.md                    # Questions and clarifications
    ‚îú‚îÄ‚îÄ plan.md                       # Step-by-step implementation plan
    ‚îú‚îÄ‚îÄ tasks.md                      # Actionable task checklist
    ‚îú‚îÄ‚îÄ research.md                   # Research notes and references
    ‚îî‚îÄ‚îÄ implementation-notes.md       # Post-implementation learnings
```

---

## Implementation Scope (This Iteration)

### In Scope ‚úÖ
- Create `backend/` folder structure
- Install SQLModel and dependencies via UV
- Create Neon database account and database
- Write `models.py` with User and Task models
- Write `db.py` with engine and session management
- Write `.env.example` template
- Create `test_db.py` to verify connection and CRUD
- Test database connection and table creation
- Document setup process

### Out of Scope ‚ùå
- FastAPI REST API endpoints (Constitution 2)
- Authentication/JWT logic (Constitution 2)
- Frontend development (Constitution 3)
- Deployment configuration (Constitution 4)
- Advanced features (sorting, filtering) - later phases

---

## Dependencies & Prerequisites

### Required Accounts
- ‚úÖ Neon account (neon.tech) - free tier
- ‚úÖ GitHub account (for version control)

### Required Tools
- ‚úÖ Python 3.13+ (already installed)
- ‚úÖ UV package manager (already installed)
- ‚úÖ Git (for version control)
- ‚úÖ Code editor (VS Code recommended)
- ‚úÖ Claude Code (for spec-driven development)

### Python Packages to Install
```bash
uv add sqlmodel psycopg2-binary python-dotenv
```

---

## Testing Strategy

### Unit Tests
- ‚úÖ Database connection successful
- ‚úÖ User model can be created
- ‚úÖ Task model can be created
- ‚úÖ User-Task relationship works
- ‚úÖ CRUD operations succeed

### Integration Tests
- ‚úÖ Create user in database
- ‚úÖ Create task for user
- ‚úÖ Query tasks by user_id
- ‚úÖ Update task status
- ‚úÖ Delete task
- ‚úÖ Verify foreign key constraints

### Test Script Requirements
Create `test_db.py` that:
1. Connects to database
2. Creates tables
3. Inserts sample user
4. Inserts sample task for that user
5. Queries data back
6. Updates task
7. Deletes task
8. Prints success messages

---

## Validation Checklist

Before moving to Constitution 2, verify:

- [ ] Neon database is accessible and responding
- [ ] `backend/models.py` contains User and Task models
- [ ] `backend/db.py` contains engine and get_session function
- [ ] `.env` file exists with valid DATABASE_URL
- [ ] `.env.example` template is documented
- [ ] Tables are created automatically on first run
- [ ] Can create a user record successfully
- [ ] Can create a task record for that user
- [ ] Can query tasks by user_id
- [ ] Can update task fields
- [ ] Can delete tasks
- [ ] Foreign key relationship enforces user existence
- [ ] No errors in console during operations
- [ ] `.gitignore` excludes `.env` and sensitive files

---

## Learning Outcomes

By completing this iteration, you will understand:
- How to set up cloud-based PostgreSQL database
- SQLModel ORM fundamentals
- Database relationships (One-to-Many)
- Environment-based configuration
- Database connection management
- Basic CRUD operations
- Data persistence concepts
- Security best practices for database credentials

---

## Next Steps (Constitution 2 Preview)

After completing this database foundation:
1. Build FastAPI REST API endpoints using these models
2. Implement Better Auth for JWT-based authentication
3. Add middleware for user verification
4. Create routes for task CRUD operations
5. Test API endpoints with Postman/Thunder Client

---

## References & Resources

### Documentation
- SQLModel Docs: https://sqlmodel.tiangolo.com/
- Neon Docs: https://neon.tech/docs/introduction
- FastAPI + SQLModel: https://fastapi.tiangolo.com/tutorial/sql-databases/
- PostgreSQL Best Practices: https://wiki.postgresql.org/wiki/Don't_Do_This

### Tutorials
- SQLModel Tutorial: https://sqlmodel.tiangolo.com/tutorial/
- Neon Quickstart: https://neon.tech/docs/get-started-with-neon/

---

## Version History

- **v1.0** - Initial constitution (Dec 9, 2025)
- Database foundation requirements defined
- SQLModel specifications documented
- Testing strategy outlined

---

**Status:** üü° Ready for Implementation
**Next Action:** Create `specs.md` with detailed technical specifications
**Estimated Time:** 4-6 hours
**Due Date:** December 9, 2025 (End of Day)

---

*Constitution authored following Spec-Driven Development principles for Hackathon II Phase II*